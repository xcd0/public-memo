import{create_object,merge_option}from"./common.js";import normalize_polyfill from"./charset/polyfill.js";import{EncoderOptions}from"./type.js";const whitespace=/[^\p{L}\p{N}]+/u,numeric_split_length=/(\d{3})/g,numeric_split_prev_char=/(\D)(\d{3})/g,numeric_split_next_char=/(\d{3})(\D)/g,normalize=/[\u0300-\u036f]/g;export default function Encoder(a={}){if(!this||this.constructor!==Encoder)return new Encoder(...arguments);if(arguments.length)for(let a=0;a<arguments.length;a++)this.assign(arguments[a]);else this.assign(a)}Encoder.prototype.assign=function(a){this.normalize=merge_option(a.normalize,!0,this.normalize);let b,c=a.include,d=c||a.exclude||a.split;if(d||""===d){if("object"==typeof d&&d.constructor!==RegExp){let a="";b=!c,c||(a+="\\p{Z}"),d.letter&&(a+="\\p{L}"),d.number&&(a+="\\p{N}",b=!!c),d.symbol&&(a+="\\p{S}"),d.punctuation&&(a+="\\p{P}"),d.control&&(a+="\\p{C}"),(d=d.char)&&(a+="object"==typeof d?d.join(""):d);try{this.split=new RegExp("["+(c?"^":"")+a+"]+","u")}catch(a){!1,this.split=/\s+/}}else this.split=d,b=!1===d||2>"a1a".split(d).length;this.numeric=merge_option(a.numeric,b)}else{try{this.split=merge_option(this.split,whitespace)}catch(a){!1,this.split=/\s+/}this.numeric=merge_option(a.numeric,merge_option(this.numeric,!0))}if(this.prepare=merge_option(a.prepare,null,this.prepare),this.finalize=merge_option(a.finalize,null,this.finalize),d=a.filter,this.filter="function"==typeof d?d:merge_option(d&&new Set(d),null,this.filter),this.dedupe=merge_option(a.dedupe,!0,this.dedupe),this.matcher=merge_option((d=a.matcher)&&new Map(d),null,this.matcher),this.mapper=merge_option((d=a.mapper)&&new Map(d),null,this.mapper),this.stemmer=merge_option((d=a.stemmer)&&new Map(d),null,this.stemmer),this.replacer=merge_option(a.replacer,null,this.replacer),this.minlength=merge_option(a.minlength,1,this.minlength),this.maxlength=merge_option(a.maxlength,1024,this.maxlength),this.rtl=merge_option(a.rtl,!1,this.rtl),this.cache=d=merge_option(a.cache,!0,this.cache),d&&(this.timer=null,this.cache_size="number"==typeof d?d:2e5,this.cache_enc=new Map,this.cache_term=new Map,this.cache_enc_length=128,this.cache_term_length=128),this.matcher_str="",this.matcher_test=null,this.stemmer_str="",this.stemmer_test=null,this.matcher)for(const a of this.matcher.keys())this.matcher_str+=(this.matcher_str?"|":"")+a;if(this.stemmer)for(const a of this.stemmer.keys())this.stemmer_str+=(this.stemmer_str?"|":"")+a;return this},Encoder.prototype.addStemmer=function(a,b){return this.stemmer||(this.stemmer=new Map),this.stemmer.set(a,b),this.stemmer_str+=(this.stemmer_str?"|":"")+a,this.stemmer_test=null,this.cache&&clear(this),this},Encoder.prototype.addFilter=function(a){return"function"==typeof a?this.filter=a:(this.filter||(this.filter=new Set),this.filter.add(a)),this.cache&&clear(this),this},Encoder.prototype.addMapper=function(a,b){return"object"==typeof a?this.addReplacer(a,b):1<a.length?this.addMatcher(a,b):(this.mapper||(this.mapper=new Map),this.mapper.set(a,b),this.cache&&clear(this),this)},Encoder.prototype.addMatcher=function(a,b){return"object"==typeof a?this.addReplacer(a,b):2>a.length&&(this.dedupe||this.mapper)?this.addMapper(a,b):(this.matcher||(this.matcher=new Map),this.matcher.set(a,b),this.matcher_str+=(this.matcher_str?"|":"")+a,this.matcher_test=null,this.cache&&clear(this),this)},Encoder.prototype.addReplacer=function(a,b){return"string"==typeof a?this.addMatcher(a,b):(this.replacer||(this.replacer=[]),this.replacer.push(a,b),this.cache&&clear(this),this)},Encoder.prototype.encode=function(a,b){if(this.cache&&a.length<=this.cache_enc_length)if(!this.timer)this.timer=setTimeout(clear,50,this);else if(this.cache_enc.has(a))return this.cache_enc.get(a);this.normalize&&("function"==typeof this.normalize?a=this.normalize(a):normalize?a=a.normalize("NFKD").replace(normalize,"").toLowerCase():a=a.toLowerCase()),this.prepare&&(a=this.prepare(a)),this.numeric&&3<a.length&&(a=a.replace(numeric_split_prev_char,"$1 $2").replace(numeric_split_next_char,"$1 $2").replace(numeric_split_length,"$1 "));const c=!(this.dedupe||this.mapper||this.filter||this.matcher||this.stemmer||this.replacer);let d,e,f=[],g=create_object(),h=this.split||""===this.split?a.split(this.split):[a];for(let j,k,l=0;l<h.length;l++)if((j=k=h[l])&&!(j.length<this.minlength||j.length>this.maxlength)){if(b){if(g[j])continue;g[j]=1}else{if(d===j)continue;d=j}if(c){f.push(j);continue}if(!(this.filter&&("function"==typeof this.filter?!this.filter(j):this.filter.has(j)))){if(this.cache&&j.length<=this.cache_term_length)if(this.timer){const a=this.cache_term.get(j);if(a||""===a){a&&f.push(a);continue}}else this.timer=setTimeout(clear,50,this);if(this.stemmer){this.stemmer_test||(this.stemmer_test=new RegExp("(?!^)("+this.stemmer_str+")$"));for(let a;a!==j&&2<j.length;)a=j,j=j.replace(this.stemmer_test,a=>this.stemmer.get(a))}if(j&&(this.mapper||this.dedupe&&1<j.length)){let a="";for(let b,c,d=0,e="";d<j.length;d++)b=j.charAt(d),b===e&&this.dedupe||(c=this.mapper&&this.mapper.get(b),c||""===c?(c!==e||!this.dedupe)&&(e=c)&&(a+=c):a+=e=b);j=a}if(this.matcher&&1<j.length&&(this.matcher_test||(this.matcher_test=new RegExp("("+this.matcher_str+")","g")),j=j.replace(this.matcher_test,a=>this.matcher.get(a))),j&&this.replacer)for(let a=0;j&&a<this.replacer.length;a+=2)j=j.replace(this.replacer[a],this.replacer[a+1]);if(this.cache&&k.length<=this.cache_term_length&&(this.cache_term.set(k,j),this.cache_term.size>this.cache_size&&(this.cache_term.clear(),this.cache_term_length=0|this.cache_term_length/1.1)),j){if(j!==k)if(b){if(g[j])continue;g[j]=1}else{if(e===j)continue;e=j}f.push(j)}}}return this.finalize&&(f=this.finalize(f)||f),this.cache&&a.length<=this.cache_enc_length&&(this.cache_enc.set(a,f),this.cache_enc.size>this.cache_size&&(this.cache_enc.clear(),this.cache_enc_length=0|this.cache_enc_length/1.1)),f};export function fallback_encoder(a){return a.normalize("NFKD").replace(normalize,"").toLowerCase().trim().split(/\s+/)}function clear(a){a.timer=null,a.cache_enc.clear(),a.cache_term.clear()}