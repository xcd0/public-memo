const VERSION=1,IndexedDB="undefined"!=typeof window&&(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),IDBTransaction="undefined"!=typeof window&&(window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction),IDBKeyRange="undefined"!=typeof window&&(window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange),fields=["map","ctx","tag","reg","cfg"];import StorageInterface from"../interface.js";import{create_object,toArray}from"../../common.js";function sanitize(a){return a.toLowerCase().replace(/[^a-z0-9_\-]/g,"")}const Index=create_object();export default function IdxDB(a,b={}){return this&&this.constructor===IdxDB?void("object"==typeof a&&(b=a,a=a.name),!a&&console.info("Default storage space was used, because a name was not passed."),this.id="flexsearch"+(a?":"+sanitize(a):""),this.field=b.field?sanitize(b.field):"",this.type=b.type,this.support_tag_search=!1,this.fastupdate=!1,this.db=null,this.trx={}):new IdxDB(a,b)}IdxDB.prototype.mount=function(a){return a.index?a.mount(this):(a.db=this,this.open())},IdxDB.prototype.open=function(){if(this.db)return this.db;let a=this;navigator.storage&&navigator.storage.persist(),Index[a.id]||(Index[a.id]=[]),Index[a.id].push(a.field);const b=IndexedDB.open(a.id,VERSION);return b.onupgradeneeded=function(){const b=a.db=this.result;for(let c,d=0;d<fields.length;d++){c=fields[d];for(let d,e=0;e<Index[a.id].length;e++)d=Index[a.id][e],b.objectStoreNames.contains(c+("reg"===c?"":d?":"+d:""))||b.createObjectStore(c+("reg"===c?"":d?":"+d:""))}},a.db=promisfy(b,function(b){a.db=b,a.db.onversionchange=function(){a.close()}})},IdxDB.prototype.close=function(){this.db&&this.db.close(),this.db=null},IdxDB.prototype.destroy=function(){const a=IndexedDB.deleteDatabase(this.id);return promisfy(a)},IdxDB.prototype.clear=function(){const a=[];for(let b,c=0;c<fields.length;c++){b=fields[c];for(let c,d=0;d<Index[this.id].length;d++)c=Index[this.id][d],a.push(b+("reg"===b?"":c?":"+c:""))}const b=this.db.transaction(a,"readwrite");for(let c=0;c<a.length;c++)b.objectStore(a[c]).clear();return promisfy(b)},IdxDB.prototype.get=function(a,b,c=0,d=0,e=!0,f=!1){const g=this.db.transaction((b?"ctx":"map")+(this.field?":"+this.field:""),"readonly"),h=g.objectStore((b?"ctx":"map")+(this.field?":"+this.field:"")),i=h.get(b?b+":"+a:a),j=this;return promisfy(i).then(function(a){let b=[];if(!a||!a.length)return b;if(e){if(!c&&!d&&1===a.length)return a[0];for(let e,f=0;f<a.length;f++)if((e=a[f])&&e.length){if(d>=e.length){d-=e.length;continue}const a=c?d+Math.min(e.length-d,c):e.length;for(let c=d;c<a;c++)b.push(e[c]);if(d=0,b.length===c)break}return f?j.enrich(b):b}return a})},IdxDB.prototype.tag=function(a,b=0,c=0,d=!1){const e=this.db.transaction("tag"+(this.field?":"+this.field:""),"readonly"),f=e.objectStore("tag"+(this.field?":"+this.field:"")),g=f.get(a),h=this;return promisfy(g).then(function(a){if(!a||!a.length||c>=a.length)return[];if(!b&&!c)return a;const e=a.slice(c,c+b);return d?h.enrich(e):e})},IdxDB.prototype.enrich=function(a){"object"!=typeof a&&(a=[a]);const b=this.db.transaction("reg","readonly"),c=b.objectStore("reg"),d=[];for(let b=0;b<a.length;b++)d[b]=promisfy(c.get(a[b]));return Promise.all(d).then(function(b){for(let c=0;c<b.length;c++)b[c]={id:a[c],doc:b[c]?JSON.parse(b[c]):null};return b})},IdxDB.prototype.has=function(a){const b=this.db.transaction("reg","readonly"),c=b.objectStore("reg"),d=c.getKey(a);return promisfy(d).then(function(a){return!!a})},IdxDB.prototype.search=null,IdxDB.prototype.info=function(){},IdxDB.prototype.transaction=function(a,b,c){const d=a+("reg"===a?"":this.field?":"+this.field:"");let e=this.trx[d+":"+b];if(e)return c.call(this,e);let f=this.db.transaction(d,b);this.trx[d+":"+b]=e=f.objectStore(d);const g=c.call(this,e);return this.trx[d+":"+b]=null,promisfy(f).finally(function(){return f=e=null,g})},IdxDB.prototype.commit=async function(a){let b=a.commit_task,c=[];a.commit_task=[];for(let d,e=0;e<b.length;e++)d=b[e],d.del&&c.push(d.del);c.length&&(await this.remove(c));a.reg.size&&(await this.transaction("map","readwrite",function(b){for(const c of a.map){const a=c[0],d=c[1];d.length&&(b.get(a).onsuccess=function(){let c,e=this.result;if(e&&e.length){const a=Math.max(e.length,d.length);for(let b,f,g=0;g<a;g++)if(f=d[g],f&&f.length)if(b=e[g],b&&b.length){for(let a=0;a<f.length;a++)b.push(f[a]);c=1}else e[g]=f,c=1}else e=d,c=1;c&&b.put(e,a)})}}),await this.transaction("ctx","readwrite",function(b){for(const c of a.ctx){const a=c[0],d=c[1];for(const c of d){const d=c[0],e=c[1];e.length&&(b.get(a+":"+d).onsuccess=function(){let c,f=this.result;if(f&&f.length){const a=Math.max(f.length,e.length);for(let b,d,g=0;g<a;g++)if(d=e[g],d&&d.length)if(b=f[g],b&&b.length){for(let a=0;a<d.length;a++)b.push(d[a]);c=1}else f[g]=d,c=1}else f=e,c=1;c&&b.put(f,a+":"+d)})}}}),a.store?await this.transaction("reg","readwrite",function(b){for(const c of a.store){const a=c[0],d=c[1];b.put("object"==typeof d?JSON.stringify(d):1,a)}}):!a.bypass&&(await this.transaction("reg","readwrite",function(b){for(const c of a.reg.keys())b.put(1,c)})),a.tag&&(await this.transaction("tag","readwrite",function(b){for(const c of a.tag){const a=c[0],d=c[1];d.length&&(b.get(a).onsuccess=function(){let c=this.result;c=c&&c.length?c.concat(d):d,b.put(c,a)})}})),a.map.clear(),a.ctx.clear(),a.tag&&a.tag.clear(),a.store&&a.store.clear(),a.document||a.reg.clear())};function handle(a,b,c){const d=a.value;let e,f=0;for(let g,h=0;h<d.length;h++){if(g=c?d:d[h]){for(let a,c,f=0;f<b.length;f++)if(c=b[f],a=g.indexOf(c),0<=a)if(e=1,1<g.length)g.splice(a,1);else{d[h]=[];break}f+=g.length}if(c)break}f?e&&a.update(d):a.delete(),a.continue()}IdxDB.prototype.remove=function(a){const b=this;return"object"!=typeof a&&(a=[a]),Promise.all([b.transaction("map","readwrite",function(b){b.openCursor().onsuccess=function(){const b=this.result;b&&handle(b,a)}}),b.transaction("ctx","readwrite",function(b){b.openCursor().onsuccess=function(){const b=this.result;b&&handle(b,a)}}),b.transaction("tag","readwrite",function(b){b.openCursor().onsuccess=function(){const b=this.result;b&&handle(b,a,!0)}}),b.transaction("reg","readwrite",function(b){for(let c=0;c<a.length;c++)b.delete(a[c])})])};function promisfy(a,b){return new Promise((c,d)=>{a.onsuccess=a.oncomplete=function(){b&&b(this.result),b=null,c(this.result)},a.onerror=a.onblocked=d,a=null})}